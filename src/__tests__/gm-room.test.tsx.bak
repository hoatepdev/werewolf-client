import React from 'react'
import { render, screen, fireEvent, waitFor } from '@testing-library/react'
import { vi, describe, it, expect, beforeEach, afterEach } from 'vitest'
import GmRoomPage from '../app/gm-room/[roomCode]/page'
import { getSocket } from '../lib/socket'
import { useRoomStore } from '../hook/useRoomStore'
import { Player } from '../types/player'

vi.mock('../lib/socket')
vi.mock('next/navigation', () => ({
  useRouter: () => ({
    push: vi.fn(),
  }),
}))

const mockSocket = {
  emit: vi.fn(),
  on: vi.fn(),
  off: vi.fn(),
}

const mockPlayers: Player[] = [
  {
    id: 'player-1',
    username: 'TestPlayer1',
    avatarKey: 1,
    status: 'approved',
    alive: true,
    role: 'werewolf',
  },
  {
    id: 'player-2',
    username: 'TestPlayer2',
    avatarKey: 2,
    status: 'approved',
    alive: true,
    role: 'seer',
  },
  {
    id: 'player-3',
    username: 'TestPlayer3',
    avatarKey: 3,
    status: 'approved',
    alive: false,
    role: 'villager',
  },
]

describe('GM Room Page', () => {
  beforeEach(() => {
    vi.clearAllMocks()
    ;(getSocket as ReturnType<typeof vi.fn>).mockReturnValue(mockSocket)

    useRoomStore.setState({
      phase: 'night',
      setPhase: vi.fn(),
    })
  })

  afterEach(() => {
    vi.restoreAllMocks()
  })

  describe('Component Rendering', () => {
    it('should render GM room page with basic elements', async () => {
      render(<GmRoomPage params={Promise.resolve({ roomCode: 'TEST123' })} />)

      await waitFor(() => {
        expect(screen.getByText('TEST123')).toBeInTheDocument()
        expect(screen.getByText('ğŸ® Äiá»u khiá»ƒn game')).toBeInTheDocument()
        expect(screen.getByText('Giai Ä‘oáº¡n tiáº¿p theo')).toBeInTheDocument()
        expect(screen.getByText('LÃ m má»›i danh sÃ¡ch')).toBeInTheDocument()
      })
    })

    it('should display current phase indicator', async () => {
      useRoomStore.setState({ phase: 'day' })

      render(<GmRoomPage params={Promise.resolve({ roomCode: 'TEST123' })} />)

      await waitFor(() => {
        expect(screen.getByText('NgÃ y')).toBeInTheDocument()
      })
    })

    it('should display connection status', async () => {
      render(<GmRoomPage params={Promise.resolve({ roomCode: 'TEST123' })} />)

      await waitFor(() => {
        expect(screen.getByText('Máº¥t káº¿t ná»‘i')).toBeInTheDocument()
      })
    })
  })

  describe('Game Statistics', () => {
    it('should display game statistics correctly', async () => {
      render(<GmRoomPage params={Promise.resolve({ roomCode: 'TEST123' })} />)

      await waitFor(() => {
        expect(screen.getByText('ğŸ“Š Thá»‘ng kÃª game')).toBeInTheDocument()
        expect(screen.getByText('Tá»•ng ngÆ°á»i chÆ¡i')).toBeInTheDocument()
        expect(screen.getByText('CÃ²n sá»‘ng')).toBeInTheDocument()
        expect(screen.getByText('ÄÃ£ cháº¿t')).toBeInTheDocument()
        expect(screen.getByText('SÃ³i cÃ²n sá»‘ng')).toBeInTheDocument()
        expect(screen.getByText('DÃ¢n lÃ ng cÃ²n sá»‘ng')).toBeInTheDocument()
      })
    })

    it('should update statistics when players change', async () => {
      const { rerender } = render(
        <GmRoomPage params={Promise.resolve({ roomCode: 'TEST123' })} />,
      )

      await waitFor(() => {
        expect(screen.getByText('0')).toBeInTheDocument() // Total players
      })

      // Simulate players update
      const mockSocketInstance = getSocket()
      const playersUpdateHandler = mockSocket.on.mock.calls.find(
        (call) => call[0] === 'gm:playersUpdate',
      )?.[1]

      if (playersUpdateHandler) {
        playersUpdateHandler({ players: mockPlayers })
      }

      rerender(<GmRoomPage params={Promise.resolve({ roomCode: 'TEST123' })} />)

      await waitFor(() => {
        expect(screen.getByText('3')).toBeInTheDocument() // Total players
        expect(screen.getByText('2')).toBeInTheDocument() // Alive players
        expect(screen.getByText('1')).toBeInTheDocument() // Dead players
      })
    })
  })

  describe('Player List', () => {
    it('should display player list when players are available', async () => {
      render(<GmRoomPage params={Promise.resolve({ roomCode: 'TEST123' })} />)

      await waitFor(() => {
        expect(screen.getByText('ğŸ‘¥ Danh sÃ¡ch ngÆ°á»i chÆ¡i')).toBeInTheDocument()
      })

      // Simulate players update
      const mockSocketInstance = getSocket()
      const playersUpdateHandler = mockSocket.on.mock.calls.find(
        (call) => call[0] === 'gm:playersUpdate',
      )?.[1]

      if (playersUpdateHandler) {
        playersUpdateHandler({ players: mockPlayers })
      }

      await waitFor(() => {
        expect(screen.getByText('TestPlayer1')).toBeInTheDocument()
        expect(screen.getByText('TestPlayer2')).toBeInTheDocument()
        expect(screen.getByText('TestPlayer3')).toBeInTheDocument()
      })
    })

    it('should display player roles correctly', async () => {
      render(<GmRoomPage params={Promise.resolve({ roomCode: 'TEST123' })} />)

      // Simulate players update
      const mockSocketInstance = getSocket()
      const playersUpdateHandler = mockSocket.on.mock.calls.find(
        (call) => call[0] === 'gm:playersUpdate',
      )?.[1]

      if (playersUpdateHandler) {
        playersUpdateHandler({ players: mockPlayers })
      }

      await waitFor(() => {
        expect(screen.getByText('werewolf')).toBeInTheDocument()
        expect(screen.getByText('seer')).toBeInTheDocument()
        expect(screen.getByText('villager')).toBeInTheDocument()
      })
    })

    it('should display player status correctly', async () => {
      render(<GmRoomPage params={Promise.resolve({ roomCode: 'TEST123' })} />)

      // Simulate players update
      const mockSocketInstance = getSocket()
      const playersUpdateHandler = mockSocket.on.mock.calls.find(
        (call) => call[0] === 'gm:playersUpdate',
      )?.[1]

      if (playersUpdateHandler) {
        playersUpdateHandler({ players: mockPlayers })
      }

      await waitFor(() => {
        expect(screen.getAllByText('Sá»‘ng')).toHaveLength(2)
        expect(screen.getByText('Cháº¿t')).toBeInTheDocument()
      })
    })
  })

  describe('Player Actions', () => {
    it('should show eliminate button for alive players', async () => {
      render(<GmRoomPage params={Promise.resolve({ roomCode: 'TEST123' })} />)

      // Simulate players update
      const mockSocketInstance = getSocket()
      const playersUpdateHandler = mockSocket.on.mock.calls.find(
        (call) => call[0] === 'gm:playersUpdate',
      )?.[1]

      if (playersUpdateHandler) {
        playersUpdateHandler({ players: mockPlayers })
      }

      await waitFor(() => {
        const eliminateButtons = screen.getAllByText('Loáº¡i bá»')
        expect(eliminateButtons).toHaveLength(2) // Only alive players
      })
    })

    it('should show revive button for dead players', async () => {
      render(<GmRoomPage params={Promise.resolve({ roomCode: 'TEST123' })} />)

      // Simulate players update
      const mockSocketInstance = getSocket()
      const playersUpdateHandler = mockSocket.on.mock.calls.find(
        (call) => call[0] === 'gm:playersUpdate',
      )?.[1]

      if (playersUpdateHandler) {
        playersUpdateHandler({ players: mockPlayers })
      }

      await waitFor(() => {
        const reviveButtons = screen.getAllByText('Há»“i sinh')
        expect(reviveButtons).toHaveLength(1) // Only dead players
      })
    })

    it('should emit eliminate player event when eliminate button is clicked', async () => {
      render(<GmRoomPage params={Promise.resolve({ roomCode: 'TEST123' })} />)

      // Simulate players update
      const mockSocketInstance = getSocket()
      const playersUpdateHandler = mockSocket.on.mock.calls.find(
        (call) => call[0] === 'gm:playersUpdate',
      )?.[1]

      if (playersUpdateHandler) {
        playersUpdateHandler({ players: mockPlayers })
      }

      await waitFor(() => {
        const eliminateButtons = screen.getAllByText('Loáº¡i bá»')
        fireEvent.click(eliminateButtons[0])
      })

      expect(mockSocket.emit).toHaveBeenCalledWith('rq_gm:eliminatePlayer', {
        roomCode: 'TEST123',
        playerId: 'player-1',
        reason: 'GM loáº¡i bá»',
      })
    })

    it('should emit revive player event when revive button is clicked', async () => {
      render(<GmRoomPage params={Promise.resolve({ roomCode: 'TEST123' })} />)

      // Simulate players update
      const mockSocketInstance = getSocket()
      const playersUpdateHandler = mockSocket.on.mock.calls.find(
        (call) => call[0] === 'gm:playersUpdate',
      )?.[1]

      if (playersUpdateHandler) {
        playersUpdateHandler({ players: mockPlayers })
      }

      await waitFor(() => {
        const reviveButtons = screen.getAllByText('Há»“i sinh')
        fireEvent.click(reviveButtons[0])
      })

      expect(mockSocket.emit).toHaveBeenCalledWith('rq_gm:revivePlayer', {
        roomCode: 'TEST123',
        playerId: 'player-3',
      })
    })
  })

  describe('Game Controls', () => {
    it('should emit next phase event when next phase button is clicked', async () => {
      render(<GmRoomPage params={Promise.resolve({ roomCode: 'TEST123' })} />)

      await waitFor(() => {
        const nextPhaseButton = screen.getByText('Giai Ä‘oáº¡n tiáº¿p theo')
        fireEvent.click(nextPhaseButton)
      })

      expect(mockSocket.emit).toHaveBeenCalledWith('rq_gm:nextPhase', {
        roomCode: 'TEST123',
      })
    })

    it('should emit get players event when refresh button is clicked', async () => {
      render(<GmRoomPage params={Promise.resolve({ roomCode: 'TEST123' })} />)

      await waitFor(() => {
        const refreshButton = screen.getByText('LÃ m má»›i danh sÃ¡ch')
        fireEvent.click(refreshButton)
      })

      expect(mockSocket.emit).toHaveBeenCalledWith('rq_gm:getPlayers', {
        roomCode: 'TEST123',
      })
    })
  })

  describe('Socket Event Handling', () => {
    it('should handle gm:connected event', async () => {
      render(<GmRoomPage params={Promise.resolve({ roomCode: 'TEST123' })} />)

      const mockSocketInstance = getSocket()
      const connectedHandler = mockSocket.on.mock.calls.find(
        (call) => call[0] === 'gm:connected',
      )?.[1]

      if (connectedHandler) {
        connectedHandler({
          roomCode: 'TEST123',
          gmRoomId: 'gm_TEST123',
          message: 'GM connected successfully',
        })
      }

      await waitFor(() => {
        expect(screen.getByText('ÄÃ£ káº¿t ná»‘i')).toBeInTheDocument()
      })
    })

    it('should handle gm:playersUpdate event', async () => {
      render(<GmRoomPage params={Promise.resolve({ roomCode: 'TEST123' })} />)

      const mockSocketInstance = getSocket()
      const playersUpdateHandler = mockSocket.on.mock.calls.find(
        (call) => call[0] === 'gm:playersUpdate',
      )?.[1]

      if (playersUpdateHandler) {
        playersUpdateHandler({ players: mockPlayers })
      }

      await waitFor(() => {
        expect(screen.getByText('TestPlayer1')).toBeInTheDocument()
        expect(screen.getByText('TestPlayer2')).toBeInTheDocument()
        expect(screen.getByText('TestPlayer3')).toBeInTheDocument()
      })
    })

    it('should handle gm:nightAction event', async () => {
      render(<GmRoomPage params={Promise.resolve({ roomCode: 'TEST123' })} />)

      const mockSocketInstance = getSocket()
      const nightActionHandler = mockSocket.on.mock.calls.find(
        (call) => call[0] === 'gm:nightAction',
      )?.[1]

      if (nightActionHandler) {
        nightActionHandler({
          step: 'werewolf',
          action: 'start',
          message: 'Xin má»i SÃ³i thá»©c dáº­y.',
          timestamp: Date.now(),
        })
      }

      await waitFor(() => {
        expect(screen.getByText('ğŸŒ™ Nháº­t kÃ½ hÃ nh Ä‘á»™ng Ä‘Ãªm')).toBeInTheDocument()
      })
    })

    it('should handle gm:votingAction event', async () => {
      render(<GmRoomPage params={Promise.resolve({ roomCode: 'TEST123' })} />)

      const mockSocketInstance = getSocket()
      const votingActionHandler = mockSocket.on.mock.calls.find(
        (call) => call[0] === 'gm:votingAction',
      )?.[1]

      if (votingActionHandler) {
        votingActionHandler({
          type: 'phaseChanged',
          message: 'Chuyá»ƒn sang giai Ä‘oáº¡n bá» phiáº¿u.',
        })
      }

      await waitFor(() => {
        expect(screen.getByText('ğŸ“‹ HÃ ng Ä‘á»£i Ã¢m thanh')).toBeInTheDocument()
      })
    })

    it('should handle gm:gameEnded event', async () => {
      render(<GmRoomPage params={Promise.resolve({ roomCode: 'TEST123' })} />)

      const mockSocketInstance = getSocket()
      const gameEndedHandler = mockSocket.on.mock.calls.find(
        (call) => call[0] === 'gm:gameEnded',
      )?.[1]

      if (gameEndedHandler) {
        gameEndedHandler({
          type: 'gameEnded',
          message: 'TrÃ² chÆ¡i káº¿t thÃºc. DÃ¢n lÃ ng tháº¯ng!',
          winner: 'villagers',
        })
      }

      await waitFor(() => {
        expect(screen.getByText('ğŸ“‹ HÃ ng Ä‘á»£i Ã¢m thanh')).toBeInTheDocument()
      })
    })
  })

  describe('Audio Queue', () => {
    it('should display audio queue when audio events are added', async () => {
      render(<GmRoomPage params={Promise.resolve({ roomCode: 'TEST123' })} />)

      await waitFor(() => {
        expect(screen.getByText('ğŸ“‹ HÃ ng Ä‘á»£i Ã¢m thanh')).toBeInTheDocument()
      })
    })

    it('should display current audio when playing', async () => {
      render(<GmRoomPage params={Promise.resolve({ roomCode: 'TEST123' })} />)

      await waitFor(() => {
        expect(screen.getByText('ğŸµ Äiá»u khiá»ƒn Ã¢m thanh')).toBeInTheDocument()
      })
    })
  })

  describe('Game Logs', () => {
    it('should display game logs section', async () => {
      render(<GmRoomPage params={Promise.resolve({ roomCode: 'TEST123' })} />)

      await waitFor(() => {
        expect(screen.getByText('Lá»‹ch sá»­ game (log)')).toBeInTheDocument()
      })
    })

    it('should log game events', async () => {
      render(<GmRoomPage params={Promise.resolve({ roomCode: 'TEST123' })} />)

      const mockSocketInstance = getSocket()
      const nightActionHandler = mockSocket.on.mock.calls.find(
        (call) => call[0] === 'gm:nightAction',
      )?.[1]

      if (nightActionHandler) {
        nightActionHandler({
          step: 'werewolf',
          action: 'start',
          message: 'Xin má»i SÃ³i thá»©c dáº­y.',
          timestamp: Date.now(),
        })
      }

      await waitFor(() => {
        expect(screen.getByText('Lá»‹ch sá»­ game (log)')).toBeInTheDocument()
      })
    })
  })
})
